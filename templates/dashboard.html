<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - DocScanner</title>
    <!-- Retaining Tailwind & DaisyUI but overriding key styles for consistency -->
    <link href="https://cdn.jsdelivr.net/npm/daisyui@3.9.4/dist/full.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .dashboard-grid {
            display: grid;
            grid-template-columns: 250px 1fr;
            min-height: 100vh;
        }
        .sidebar {
            background-color: #000;
            color: #fff;
            padding: 1rem;
        }
        .menu a {
            color: #fff;
        }
        .chart-container {
            position: relative;
            height: 400px;
        }
    </style>
</head>
<body>
    <div class="dashboard-grid">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="mb-8">
                <h1 class="text-xl font-bold">DocScanner Admin</h1>
                <p class="text-sm">Analytics Dashboard</p>
            </div>
            <ul class="menu">
                <li><a href="/admin/dashboard" class="active">ðŸ“Š Analytics</a></li>
                <li><a href="#user-management">ðŸ‘¥ User Management</a></li>
                <li><a href="#documents">ðŸ“„ Documents</a></li>
                <li><a href="#credits">ðŸª™ Credit Requests</a></li>
                <li><a href="#" id="logout-btn">ðŸšª Logout</a></li>
            </ul>
        </aside>

        <!-- Main Content -->
        <main class="p-8">
            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">Total Scans</div>
                        <div class="stat-value" id="total-scans">0</div>
                        <div class="stat-desc">Document uploads</div>
                    </div>
                </div>
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">Active Users</div>
                        <div class="stat-value" id="active-users">0</div>
                        <div class="stat-desc">Last 24 hours</div>
                    </div>
                </div>
                <div class="stats shadow">
                    <div class="stat">
                        <div class="stat-title">Pending Credits</div>
                        <div class="stat-value" id="pending-credits">0</div>
                        <div class="stat-desc">Requests to review</div>
                    </div>
                </div>
            </div>

            <!-- Charts -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                <div class="card shadow">
                    <div class="card-body">
                        <h2 class="card-title">Scan Activity</h2>
                        <div class="chart-container">
                            <canvas id="scansChart"></canvas>
                        </div>
                    </div>
                </div>
                
                <div class="card shadow">
                    <div class="card-body">
                        <h2 class="card-title">User Distribution</h2>
                        <div class="chart-container">
                            <canvas id="usersChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <div class="card shadow">
                <div class="card-body">
                    <h2 class="card-title">Recent Matches</h2>
                    <div class="overflow-x-auto">
                        <table class="table table-zebra">
                            <thead>
                                <tr>
                                    <th>User</th>
                                    <th>Document</th>
                                    <th>Similarity</th>
                                    <th>Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="recent-matches">
                                <!-- Will be populated by JavaScript -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // (Dashboard JS remains the same as before, with logout and analytics update)
        async function loadAnalytics() {
            try {
                const response = await fetch('/admin/analytics');
                if (!response.ok) {
                    throw new Error(`Failed to fetch analytics: ${response.status}`);
                }
                const data = await response.json();
                console.log("Analytics data:", data);
                document.getElementById('total-scans').textContent = data.total_scans || 0;
                document.getElementById('active-users').textContent = data.active_users || 0;
                document.getElementById('pending-credits').textContent = data.pending_credits || 0;
                
                const timelineData = data.scan_timeline || [];
                const labels = timelineData.map(entry => new Date(entry.date).toLocaleDateString());
                const counts = timelineData.map(entry => entry.count);
                
                const scansChartCanvas = document.getElementById('scansChart');
                if (scansChartCanvas) {
                    if (window.scansChart && window.scansChart.data && window.scansChart.data.datasets) {
                        window.scansChart.data.labels = labels;
                        window.scansChart.data.datasets[0].data = counts;
                        window.scansChart.update();
                    } else {
                        window.scansChart = new Chart(scansChartCanvas, {
                            type: 'line',
                            data: {
                                labels: labels,
                                datasets: [{
                                    label: 'Daily Scans',
                                    data: counts,
                                    borderColor: '#000',
                                    tension: 0.1
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false
                            }
                        });
                    }
                }
                
                const userDistribution = data.user_distribution || [];
                const roles = userDistribution.map(u => u.role);
                const userCounts = userDistribution.map(u => u.count);
                
                const usersChartCanvas = document.getElementById('usersChart');
                if (usersChartCanvas) {
                    if (window.usersChart && window.usersChart.data && window.usersChart.data.datasets) {
                        window.usersChart.data.labels = roles;
                        window.usersChart.data.datasets[0].data = userCounts;
                        window.usersChart.update();
                    } else {
                        window.usersChart = new Chart(usersChartCanvas, {
                            type: 'doughnut',
                            data: {
                                labels: roles,
                                datasets: [{
                                    data: userCounts,
                                    backgroundColor: ['#000', '#555', '#888']
                                }]
                            },
                            options: {
                                responsive: true,
                                maintainAspectRatio: false,
                                plugins: {
                                    legend: { position: 'bottom' }
                                }
                            }
                        });
                    }
                }
                
                const matchesTable = document.getElementById('recent-matches');
                const recentMatches = data.recent_matches || [];
                if (recentMatches.length === 0) {
                    matchesTable.innerHTML = `<tr><td colspan="5" class="text-center">No recent matches found</td></tr>`;
                } else {
                    matchesTable.innerHTML = recentMatches.map(match => `
                        <tr>
                            <td>${match.username || 'Unknown'}</td>
                            <td>${match.filename || 'Unknown'}</td>
                            <td>${typeof match.similarity === 'number' ? (match.similarity * 100).toFixed(1) : 'N/A'}%</td>
                            <td>${match.timestamp ? new Date(match.timestamp).toLocaleString() : 'N/A'}</td>
                            <td>
                                <button class="btn btn-xs btn-ghost">View</button>
                                <button class="btn btn-xs btn-ghost text-error">Flag</button>
                            </td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Analytics error:', error);
                alert('Failed to load analytics data: ' + error.message);
            }
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            loadAnalytics();
            setInterval(loadAnalytics, 30000);
            
            document.getElementById('logout-btn').addEventListener('click', async () => {
                try {
                    const response = await fetch('/auth/logout', { method: 'POST' });
                    if (response.ok) {
                        window.location.href = '/page/login';
                    } else {
                        alert('Logout failed');
                    }
                } catch (error) {
                    alert('Network error during logout');
                }
            });
        });
    </script>
</body>
</html>
